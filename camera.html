<html>
<head>
<title>Camera Test</title>
<script src="https://code.jquery.com/jquery-3.1.1.js" integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA=" crossorigin="anonymous"></script>
<script src="opencv.js/opencv.js"></script>
<script>
    if (!navigator.mediaDevices) {
    console.log("enumerateDevices() not supported.");
    }
    else
    {

        // List cameras and microphones.
        navigator.mediaDevices.getUserMedia({
            video: {
                width: {
                    min: 1280,
                    ideal: 1920,
                    max: 2560,
                },
                height: {
                    min: 720,
                    ideal: 1080,
                    max: 1440
                },
                facingMode: 'environment',
                zoom:true,
            }
        }).then(function(stream) {
        /* use the stream */
            $("#msg").append("<p>v10 backfacing camera with zoom found</p>")
            var video = document.querySelector('video');
            video.srcObject = stream;
            video.setAttribute('playsinline', true);
            const [track] = stream.getVideoTracks();
            const capabilities = track.getCapabilities();
            const settings = track.getSettings();

            //https://googlechrome.github.io/samples/image-capture/update-camera-zoom.html
            video.onloadedmetadata = (function(e) {
                // Do something with the video here.
                this.applyConstraints({advanced: [ {zoom: 2}, {focusMode:"continuous"} ]});
            }).bind(track);
            var can = document.createElement("CANVAS");
            can.width = settings.width;
            can.height = settings.height;
            can.id="preview";
            $(document.body).append(can);
            $("#msg").append(`<p>${JSON.stringify(settings)}</p>`);
            $("#msg").append(`<p>${JSON.stringify(capabilities)}</p>`);
            
            setTimeout((function(){
                this.applyConstraints({advanced: [{torch: true}]});
            }).bind(track), 1000);

            setInterval((function(){
                var ctx = $("#preview")[0].getContext('2d');
                var canv = $("#canv")[0];
                ctx.drawImage(video, 0, 0);
                let imageData = ctx.getImageData(0, 0, canv.width, canv.height);
                let mat = cv.matFromImageData(imageData);
                cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY);
                cv.Canny(mat, mat, 150, 300, 3, false);
                cv.imshow("canv", mat);
                //assert.deepEqual(mat.data, new Uint8Array(imageData.data));
                mat.delete();                
            }).bind(track), 50);

        }).catch(function(err) {
            $("#msg").append(`<p>${err}</p>`)
        });
    }
</script>
<style>
	canvas{
	border:1px solid black;}
</style>
</head>
<body>
    <video id="camera" autoplay></video>
    <canvas id="canv" width="500" height="500"></canvas>
    <div id="msg"></div>
</body>
</html>